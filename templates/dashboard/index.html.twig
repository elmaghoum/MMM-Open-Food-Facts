{% extends 'base.html.twig' %}

{% block title %}Dashboard - MMM{% endblock %}

{% block main_class %}{% endblock %}

{% block body %}
<div class="flex h-screen bg-gray-50">
    {# Sidebar droite avec widgets disponibles #}
    <div class="w-80 bg-white border-l border-gray-200 overflow-y-auto">
        <div class="p-6">
            <h2 class="text-xl font-bold mb-4">Widgets</h2>
            
            {# Widget Recherche Produit #}
            <div class="mb-4 p-4 bg-blue-50 rounded-lg border-2 border-dashed border-blue-300 cursor-move hover:bg-blue-100 transition"
                 draggable="true"
                 data-widget-type="product_search">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-2"></span>
                    <h3 class="font-semibold">Recherche Produit</h3>
                </div>
                <p class="text-xs text-gray-600">Rechercher et afficher les détails d'un produit</p>
            </div>

            {# Widget Comparaison Sucre/Sel #}
            <div class="mb-4 p-4 bg-green-50 rounded-lg border-2 border-dashed border-green-300 cursor-move hover:bg-green-100 transition"
                 draggable="true"
                 data-widget-type="sugar_salt_comparison">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-2"></span>
                    <h3 class="font-semibold">Sucre et Sel</h3>
                </div>
                <p class="text-xs text-gray-600">Comparer le sucre et sel (1-5 produits)</p>
            </div>

            {# Widget Comparaison Nutriscore #}
            <div class="mb-4 p-4 bg-yellow-50 rounded-lg border-2 border-dashed border-yellow-300 cursor-move hover:bg-yellow-100 transition"
                 draggable="true"
                 data-widget-type="nutriscore_comparison">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-2"></span>
                    <h3 class="font-semibold">Nutriscore</h3>
                </div>
                <p class="text-xs text-gray-600">Comparer les Nutriscores (1-5 produits)</p>
            </div>

            {# Widget Comparaison NOVA #}
            <div class="mb-4 p-4 bg-purple-50 rounded-lg border-2 border-dashed border-purple-300 cursor-move hover:bg-purple-100 transition"
                 draggable="true"
                 data-widget-type="nova_comparison">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-2"></span>
                    <h3 class="font-semibold">NOVA</h3>
                </div>
                <p class="text-xs text-gray-600">Comparer les scores NOVA (1-5 produits)</p>
            </div>

            {# Widget Nutrition Pie #}
            <div class="mb-4 p-4 bg-pink-50 rounded-lg border-2 border-dashed border-pink-300 cursor-move hover:bg-pink-100 transition"
                 draggable="true"
                 data-widget-type="nutrition_pie">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-2"></span>
                    <h3 class="font-semibold">Nutrition Pie</h3>
                </div>
                <p class="text-xs text-gray-600">Graphique nutritionnel d'un produit</p>
            </div>
        </div>
    </div>

    {# Zone de dashboard principale #}
    <div class="flex-1 p-6 overflow-y-auto">
        <div class="mb-6 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold">Mon Dashboard</h1>
                <p class="text-gray-600">Glissez-déposez les widgets depuis la barre latérale</p>
            </div>
            {% if dashboard and dashboard.widgets|length > 0 %}
                <div class="text-sm text-gray-500">
                    {{ dashboard.widgets|length }} / 10 widgets
                </div>
            {% endif %}
        </div>

        {# Grille Dashboard - Hauteur adaptative, 2 colonnes, widgets hauteur 400px #}
        <div id="dashboard-grid" 
             class="relative bg-gray-100 rounded-lg p-4 border-2 border-dashed border-gray-300 grid grid-cols-2 gap-4"
             style="grid-auto-rows: 400px;">
            
            {% if dashboard and dashboard.widgets|length > 0 %}
                {% for widget in dashboard.widgets %}
                    <div class="widget-container bg-white rounded-lg border-2 border-gray-200 p-4 shadow-sm hover:shadow-md transition"
                         style="min-width: 650px; height: 400px;"
                         data-widget-id="{{ widget.id.toRfc4122 }}"
                         data-widget-type="{{ widget.type.value }}"
                         data-row="{{ widget.row }}"
                         data-column="{{ widget.column }}">
                        
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-lg">
                                {% if widget.type.value == 'product_search' %}Recherche
                                {% elseif widget.type.value == 'sugar_salt_comparison' %}Sucre et Sel
                                {% elseif widget.type.value == 'nutriscore_comparison' %}Nutriscore
                                {% elseif widget.type.value == 'nova_comparison' %}NOVA
                                {% elseif widget.type.value == 'nutrition_pie' %}Nutrition
                                {% endif %}
                            </h3>
                            <div class="flex items-center gap-2">
                                <button class="edit-widget text-blue-500 hover:text-blue-700 text-xl" 
                                        data-widget-id="{{ widget.id.toRfc4122 }}"
                                        data-widget-type="{{ widget.type.value }}"
                                        data-configuration='{{ widget.configuration|json_encode }}'>
                                    ⚙️
                                </button>
                                <button class="remove-widget text-red-500 hover:text-red-700 font-bold text-xl" 
                                        data-widget-id="{{ widget.id.toRfc4122 }}">
                                    ×
                                </button>
                            </div>
                        </div>

                        <div class="widget-content overflow-auto" 
                             style="height: calc(100% - 50px);"
                             id="widget-content-{{ widget.id.toRfc4122 }}">
                            <p class="text-gray-500 text-center py-8">Chargement...</p>
                        </div>
                    </div>
                {% endfor %}
                
                {# Indication pour ajouter plus de widgets
                {% if dashboard.widgets|length < 8 %}
                    <div class="col-span-2 text-center py-6 border-2 border-dashed border-gray-300 rounded-lg bg-blue-50">
                        <p class="text-gray-600 text-sm">
                            ⬆️ Vous pouvez ajouter encore <strong>{{ 10 - dashboard.widgets|length }} widget(s)</strong> en glissant-déposant depuis la barre latérale
                        </p>
                    </div>
                {% endif %} #}
            {% else %}
                <div class="col-span-2 flex items-center justify-center" style="min-height: 600px;">
                    <div class="text-center">
                        <div class="text-6xl mb-4"></div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Glissez un widget ici</h3>
                        <p class="text-gray-500">Commencez par glisser un widget depuis la barre latérale (max 10 widgets)</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    {{ encore_entry_script_tags('dashboard') }}
{% endblock %}